rules_version = '2';

/**
 * Firebase Security Rules for GharBazaar
 * Business-ready security for production deployment
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user has a specific role
    function hasRole(role) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    // Check if user is admin
    function isAdmin() {
      return hasRole('admin');
    }
    
    // Check if user is a partner
    function isPartner() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['ground_partner', 'legal_partner', 'promotion_partner', 'partner'];
    }
    
    // Validate required fields exist
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }
    
    // Check if only allowed fields are being updated
    function onlyUpdates(fields) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(fields);
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Anyone can read public user profiles
      allow read: if isAuthenticated();
      
      // Users can create their own profile
      allow create: if isOwner(userId) && 
        hasRequiredFields(['email', 'displayName', 'role', 'createdAt']);
      
      // Users can update their own profile (limited fields)
      allow update: if isOwner(userId) && 
        onlyUpdates(['displayName', 'phoneNumber', 'avatar', 'address', 'city', 'state', 'pincode', 'preferences', 'notificationPreferences', 'fcmToken', 'lastSeen', 'onlineStatus', 'updatedAt']);
      
      // Admins can update any user
      allow update: if isAdmin();
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // ============================================
    // PROPERTIES COLLECTION
    // ============================================
    match /properties/{propertyId} {
      // Anyone can read active properties
      allow read: if resource.data.status == 'active' || 
        isOwner(resource.data.sellerId) || 
        isAdmin();
      
      // Authenticated users can create properties
      allow create: if isAuthenticated() && 
        request.resource.data.sellerId == request.auth.uid &&
        hasRequiredFields(['title', 'description', 'propertyType', 'price', 'address', 'sellerId', 'status', 'createdAt']);
      
      // Owners can update their properties
      allow update: if isOwner(resource.data.sellerId) || isAdmin();
      
      // Owners and admins can delete
      allow delete: if isOwner(resource.data.sellerId) || isAdmin();
    }
    
    // ============================================
    // INQUIRIES COLLECTION
    // ============================================
    match /inquiries/{inquiryId} {
      // Buyer or seller can read
      allow read: if isOwner(resource.data.buyerId) || 
        isOwner(resource.data.sellerId) || 
        isAdmin();
      
      // Authenticated users can create
      allow create: if isAuthenticated() && 
        request.resource.data.buyerId == request.auth.uid;
      
      // Participants can update
      allow update: if isOwner(resource.data.buyerId) || 
        isOwner(resource.data.sellerId) || 
        isAdmin();
      
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // ============================================
    // BIDS COLLECTION
    // ============================================
    match /bids/{bidId} {
      // Buyer or seller can read
      allow read: if isOwner(resource.data.buyerId) || 
        isOwner(resource.data.sellerId) || 
        isAdmin();
      
      // Buyers can create bids
      allow create: if isAuthenticated() && 
        request.resource.data.buyerId == request.auth.uid &&
        hasRequiredFields(['propertyId', 'amount', 'buyerId', 'sellerId', 'status', 'createdAt']);
      
      // Participants can update
      allow update: if isOwner(resource.data.buyerId) || 
        isOwner(resource.data.sellerId) || 
        isAdmin();
      
      // Only admin or bid owner can delete
      allow delete: if isOwner(resource.data.buyerId) || isAdmin();
    }
    
    // ============================================
    // CONVERSATIONS COLLECTION
    // ============================================
    match /conversations/{conversationId} {
      // Only participants can read
      allow read: if isAuthenticated() && 
        request.auth.uid in resource.data.participants;
      
      // Authenticated users can create
      allow create: if isAuthenticated() && 
        request.auth.uid in request.resource.data.participants;
      
      // Participants can update
      allow update: if isAuthenticated() && 
        request.auth.uid in resource.data.participants;
      
      // No deletion allowed (soft delete only)
      allow delete: if false;
    }
    
    // ============================================
    // MESSAGES COLLECTION
    // ============================================
    match /messages/{messageId} {
      // Read if user is a participant in the conversation
      allow read: if isAuthenticated() && 
        exists(/databases/$(database)/documents/conversations/$(resource.data.conversationId)) &&
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participants;
      
      // Authenticated users can create in valid conversations
      allow create: if isAuthenticated() && 
        request.resource.data.senderId == request.auth.uid;
      
      // Sender can update (for read receipts)
      allow update: if isAuthenticated();
      
      // No deletion
      allow delete: if false;
    }
    
    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isOwner(resource.data.userId);
      
      // Only server can create (via admin SDK)
      allow create: if false;
      
      // Users can mark their notifications as read
      allow update: if isOwner(resource.data.userId) && 
        onlyUpdates(['read', 'readAt']);
      
      // Users can delete their own notifications
      allow delete: if isOwner(resource.data.userId);
    }
    
    // ============================================
    // TRANSACTIONS COLLECTION
    // ============================================
    match /transactions/{transactionId} {
      // Users can read their own transactions
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      // Only server can create/update
      allow create, update, delete: if false;
    }
    
    // ============================================
    // REVIEWS COLLECTION
    // ============================================
    match /reviews/{reviewId} {
      // Anyone can read reviews
      allow read: if true;
      
      // Authenticated users can create reviews
      allow create: if isAuthenticated() && 
        request.resource.data.reviewerId == request.auth.uid &&
        hasRequiredFields(['rating', 'comment', 'reviewerId', 'createdAt']);
      
      // Reviewers can update their own reviews
      allow update: if isOwner(resource.data.reviewerId) || isAdmin();
      
      // Reviewers and admins can delete
      allow delete: if isOwner(resource.data.reviewerId) || isAdmin();
    }
    
    // ============================================
    // FAVORITES COLLECTION
    // ============================================
    match /favorites/{favoriteId} {
      // Users can read their own favorites
      allow read: if isOwner(resource.data.userId);
      
      // Users can create favorites
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Users can delete their favorites
      allow delete: if isOwner(resource.data.userId);
    }
    
    // ============================================
    // PROPERTY VIEWS COLLECTION
    // ============================================
    match /propertyViews/{viewId} {
      // Property owners and admins can read
      allow read: if isAdmin() || 
        get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.sellerId == request.auth.uid;
      
      // Authenticated users can create
      allow create: if isAuthenticated();
      
      // No updates or deletes
      allow update, delete: if false;
    }
    
    // ============================================
    // PARTNERS COLLECTION
    // ============================================
    match /partners/{partnerId} {
      // Partners can read their own data
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      // Applications handled by server
      allow create: if false;
      
      // Partners can update limited fields
      allow update: if isOwner(resource.data.userId) && 
        onlyUpdates(['phoneNumber', 'address', 'availability', 'updatedAt']);
      
      // Admin operations
      allow update, delete: if isAdmin();
    }
    
    // ============================================
    // TASKS COLLECTION (Partner tasks)
    // ============================================
    match /tasks/{taskId} {
      // Assigned partner or admin can read
      allow read: if isOwner(resource.data.assignedTo) || isAdmin();
      
      // Only server can create
      allow create: if false;
      
      // Assigned partner can update
      allow update: if isOwner(resource.data.assignedTo) && 
        onlyUpdates(['status', 'notes', 'completedAt', 'updatedAt']);
      
      // Admin full access
      allow update, delete: if isAdmin();
    }
    
    // ============================================
    // LEADS COLLECTION
    // ============================================
    match /leads/{leadId} {
      // Assigned agent or admin can read
      allow read: if isOwner(resource.data.assignedTo) || isAdmin();
      
      // Only server can create
      allow create: if false;
      
      // Assigned user can update
      allow update: if isOwner(resource.data.assignedTo) || isAdmin();
      
      // Admin only delete
      allow delete: if isAdmin();
    }
    
    // ============================================
    // ANALYTICS COLLECTION
    // ============================================
    match /analytics/{docId} {
      // Only admins can read analytics
      allow read: if isAdmin();
      
      // Only server can write
      allow create, update, delete: if false;
    }
    
    // ============================================
    // SYSTEM CONFIGURATION
    // ============================================
    match /config/{docId} {
      // Anyone can read public config
      allow read: if true;
      
      // Only admins can write
      allow write: if isAdmin();
    }
    
    // ============================================
    // SUBSCRIPTION PLANS
    // ============================================
    match /subscriptionPlans/{planId} {
      // Anyone can read plans
      allow read: if true;
      
      // Only admins can write
      allow write: if isAdmin();
    }
    
    // ============================================
    // USER SUBSCRIPTIONS
    // ============================================
    match /userSubscriptions/{subId} {
      // Users can read their own subscriptions
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      // Only server can write
      allow create, update, delete: if false;
    }
  }
}
